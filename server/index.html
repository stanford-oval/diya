<!-- CSS Styles -->
<style>
  .speech {border: 1px solid #DDD; width: 300px; padding: 0; margin: 0}
  .speech input {border: 0; width: 240px; display: inline-block; height: 30px;}
  .speech img {float: right; width: 40px }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>



<body>
    Hi Mikey!
    <br><br>
    <div id='transcript'>asdf</div>
    <hr>
    <h3>Email</h3>
    email:
    <br>
    <input>
    <br>
    <br>
    body:
    <br>
    <textarea rows="4" cols="50"></textarea>
    <br>
    <br>
    <button id=send>Send</button>
    <br>
    <br>
    <hr>
    <h3>Test</h3>
    <button name='say' href>Hello</button>
    <h3>Links</h3>
    <a href="#">link 1</a>
    <br><br>
    <a href="#">link 2</a>
    <br><br>
    <a href="">link 3</a>
    <br><br>
    <a href="#">link 4</a>
    <br><br>
    <hr>
    <h3>Buttons</h3>
    <button>Say Hello</button>
    <br><br>
    <button>2 Billion</button>
    <br><br>
    <hr>
    <h3>Login</h3>
    first name: <input>
    <br>
    <br>
    last name: <input>
    <br>
    <br>
    password: <input>
    <br>
    <br>
    <hr>
    <br>
    <a href="/sheets">Sheets</a>
    <br>
    <br>
    <hr>

    <div id='speech'></div>

    <script>

    function speak(message) {
      // var msg = new SpeechSynthesisUtterance(message)
      // window.speechSynthesis.speak(msg)
    }

    $("button[name='say']").on('click', (event)=>{
        speak($(event.target).text())
    })

    $("#send").on('click', ()=>{
        $('textarea').val('')
        $('input').val('')
        // speak('Hello, world')
    })

    current_click = ""
    $('body').on('click', (event)=>{
        current_click = event.target.tagName

    })

    if (annyang) {
        var commands = {
            'this is a *var_name': tag_variable,
            'this is an *var_name': tag_variable,
        };

        annyang.addCommands(commands);
        annyang.start()
    }

    annyang.addCallback('result', function(whatWasHeardArray) {
        console.log('result')
        console.log(whatWasHeardArray)
        $("#transcript").text(whatWasHeardArray[0])
    })

    annyang.addCallback('start', function(whatWasHeardArray) {
        $("#transcript").text('[start]')
    })

    annyang.addCallback('soundstart', function() {
        $("#transcript").text('[soundstart]')
    })

    function tag_variable(var_name){
        if(current_click == 'TEXTAREA'){
            replaceSelectedTextArea($('textarea')[0], "[" + var_name + "] ")
        }

        if(current_click == 'INPUT'){
            replaceSelectedInput($('input')[0], "[" + var_name + "] ")
        }
    }

    function getInputSelection(el) {
        var start = 0, end = 0, normalizedValue, range,
            textInputRange, len, endRange;

        if (typeof el.selectionStart == "number" && typeof el.selectionEnd == "number") {
            start = el.selectionStart;
            end = el.selectionEnd;
        } else {
            range = document.selection.createRange();

            if (range && range.parentElement() == el) {
                len = el.value.length;
                normalizedValue = el.value.replace(/\r\n/g, "\n");

                // Create a working TextRange that lives only in the input
                textInputRange = el.createTextRange();
                textInputRange.moveToBookmark(range.getBookmark());

                // Check if the start and end of the selection are at the very end
                // of the input, since moveStart/moveEnd doesn't return what we want
                // in those cases
                endRange = el.createTextRange();
                endRange.collapse(false);

                if (textInputRange.compareEndPoints("StartToEnd", endRange) > -1) {
                    start = end = len;
                } else {
                    start = -textInputRange.moveStart("character", -len);
                    start += normalizedValue.slice(0, start).split("\n").length - 1;

                    if (textInputRange.compareEndPoints("EndToEnd", endRange) > -1) {
                        end = len;
                    } else {
                        end = -textInputRange.moveEnd("character", -len);
                        end += normalizedValue.slice(0, end).split("\n").length - 1;
                    }
                }
            }
        }

        return {
            start: start,
            end: end
        };
    }

    function replaceSelectedInput(el, text) {
        $(el).val(text)
    }

    function replaceSelectedTextArea(el, text) {
        var sel = getInputSelection(el), val = el.value;
        el.value = val.slice(0, sel.start) + text + val.slice(sel.end);
    }

    </script>
</body>
